<!DOCTYPE html>
<html class="light" lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>미디어 창의실 예약 시스템</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              display: ["Lexend", "Noto Sans KR", "system-ui", "sans-serif"],
              sans: ["Noto Sans KR", "system-ui", "sans-serif"],
            },
            colors: {
              primary: "#2b8cee",
              "primary-soft": "#dbeafe",
              success: "#16a34a",
              error: "#dc2626",
              "background-light": "#f6f7f8",
              "background-dark": "#020617",
              "card-light": "#ffffff",
              "card-dark": "#020617",
              "border-light": "#e5e7eb",
              "border-dark": "#1f2937",
              "text-light": "#111827",
              "text-dark": "#e5e7eb",
            },
            borderRadius: {
              DEFAULT: "0.75rem",
            },
          },
        },
      };
    </script>

    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
      html,
      body {
        scroll-behavior: smooth;
      }
    </style>
  </head>

  <body
    class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark"
  >
    <div
      class="relative flex min-h-screen w-full flex-col items-center justify-start p-4 sm:p-6 lg:p-8"
    >
      <div class="w-full max-w-5xl">
        <!-- HEADER -->
        <header
          class="rounded-t-2xl border border-b-0 border-border-light bg-card-light px-4 py-4 shadow-sm dark:border-border-dark dark:bg-card-dark sm:px-8"
        >
          <div
            class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
          >
            <div class="flex items-center gap-3">
              <div class="text-primary">
                <span class="material-symbols-outlined text-3xl"> movie </span>
              </div>
              <div>
                <h1 class="text-lg font-bold leading-tight tracking-tight sm:text-xl">
                  미디어 창의실 예약 시스템
                </h1>
                <p class="mt-0.5 text-xs text-gray-500 dark:text-gray-400">
                  아래에서 현황을 확인하고, 예약·결과·취소까지 한 번에 처리하세요.
                </p>
              </div>
            </div>
            <div
              class="inline-flex items-center gap-2 self-start rounded-full bg-gray-100 px-3 py-1 text-[11px] font-medium text-gray-600 dark:bg-slate-900 dark:text-gray-300"
            >
              <span
                class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white text-[10px] shadow-sm dark:bg-slate-800"
                >●</span
              >
              실시간 n8n 연동
            </div>
          </div>
        </header>

        <!-- MAIN CARD -->
        <main
          class="rounded-b-2xl border border-border-light bg-card-light p-4 shadow-lg dark:border-border-dark dark:bg-card-dark sm:px-8 sm:py-6"
        >
          <!-- 1. 예약 현황 (메인 화면) -->
          <section id="section-status" class="space-y-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <h2 class="text-base font-semibold">실시간 예약 현황</h2>
              <div class="flex items-center gap-2">
                <div
                  class="flex gap-2 rounded-full bg-gray-100 p-1 text-xs dark:bg-slate-900"
                >
                  <button
                    type="button"
                    data-room-filter="all"
                    class="room-filter-btn rounded-full bg-primary px-3 py-1 font-medium text-white"
                  >
                    전체
                  </button>
                  <button
                    type="button"
                    data-room-filter="1실"
                    class="room-filter-btn rounded-full px-3 py-1 font-medium text-gray-700 dark:text-gray-200"
                  >
                    1실
                  </button>
                  <button
                    type="button"
                    data-room-filter="2실"
                    class="room-filter-btn rounded-full px-3 py-1 font-medium text-gray-700 dark:text-gray-200"
                  >
                    2실
                  </button>
                </div>
                <button
                  type="button"
                  id="status-refresh"
                  class="inline-flex items-center gap-1 rounded-full border border-border-light px-2.5 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50 dark:border-border-dark dark:text-gray-200 dark:hover:bg-slate-800"
                >
                  <span class="material-symbols-outlined text-[16px]">
                    refresh
                  </span>
                  새로고침
                </button>
              </div>
            </div>

            <p id="status-status" class="text-xs text-gray-500">
              페이지를 열면 자동으로 한 번 불러오고, 필요하면 새로고침을 눌러 최신
              예약을 확인하세요.
            </p>

            <div
              class="overflow-x-auto rounded-xl border border-border-light dark:border-border-dark"
            >
              <table class="min-w-full text-left text-sm">
                <thead
                  class="bg-background-light text-xs uppercase text-gray-500 dark:bg-background-dark"
                >
                  <tr>
                    <th class="px-4 py-3">창의실</th>
                    <th class="px-4 py-3">날짜</th>
                    <th class="px-4 py-3">시간</th>
                    <th class="px-4 py-3">예약자</th>
                    <th class="hidden px-4 py-3 md:table-cell">학번</th>
                    <th class="hidden px-4 py-3 lg:table-cell">목적</th>
                    <th class="px-4 py-3 text-center">상태</th>
                  </tr>
                </thead>
                <tbody
                  id="status-body"
                  class="divide-y divide-border-light dark:divide-border-dark"
                ></tbody>
              </table>
            </div>

            <!-- 예약하기 버튼 -->
            <div class="mt-4 flex justify-end">
              <button
                type="button"
                id="open-reserve"
                class="inline-flex items-center gap-1 rounded-full bg-primary px-4 py-2 text-sm font-semibold text-white shadow-md shadow-primary/30 hover:bg-blue-600"
              >
                <span class="material-symbols-outlined text-[18px]">
                  add_circle
                </span>
                예약하기
              </button>
            </div>
          </section>

          <hr class="my-6 border-dashed border-border-light dark:border-border-dark" />

          <!-- 2. 예약하기 폼 (처음엔 접혀 있음) -->
          <section id="section-reserve" class="space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-semibold">예약하기</h2>
              <button
                type="button"
                id="close-reserve"
                class="inline-flex items-center gap-1 rounded-full border border-border-light px-2.5 py-1 text-xs font-medium text-gray-600 hover:bg-gray-50 dark:border-border-dark dark:text-gray-300 dark:hover:bg-slate-800"
              >
                <span class="material-symbols-outlined text-[16px]">
                  expand_less
                </span>
                접기
              </button>
            </div>

            <p id="reserve-status" class="hidden text-sm"></p>

            <form id="reserve-form" class="space-y-8">
              <div class="grid grid-cols-1 gap-x-6 gap-y-6 md:grid-cols-2">
                <!-- 이름 -->
                <div class="flex flex-col">
                  <label
                    for="name"
                    class="pb-2 text-sm font-medium leading-normal"
                    >이름 (Name)</label
                  >
                  <input
                    id="name"
                    name="name"
                    type="text"
                    required
                    placeholder="이름을 입력하세요"
                    class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                  />
                </div>

                <!-- 학번 -->
                <div class="flex flex-col">
                  <label
                    for="student-id"
                    class="pb-2 text-sm font-medium leading-normal"
                    >학번 (Student ID)</label
                  >
                  <input
                    id="student-id"
                    name="student-id"
                    type="text"
                    required
                    placeholder="예: 1416"
                    class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                  />
                  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    학번 4자리 정도 형식으로 입력해주세요.
                  </p>
                </div>
              </div>

              <!-- 이메일 -->
              <div class="flex flex-col">
                <label
                  for="email"
                  class="pb-2 text-sm font-medium leading-normal"
                  >이메일 (Email)</label
                >
                <input
                  id="email"
                  name="email"
                  type="email"
                  required
                  placeholder="학교 이메일을 입력하세요"
                  class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                />
              </div>

              <!-- 날짜 -->
              <div class="flex flex-col">
                <label
                  for="date"
                  class="pb-2 text-sm font-medium leading-normal"
                  >날짜 (Date)</label
                >
                <input
                  id="date"
                  name="date"
                  type="date"
                  required
                  class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                />
              </div>

              <!-- 창의실 & 시간 -->
              <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <!-- 창의실 -->
                <fieldset>
                  <legend
                    class="pb-2 text-sm font-medium leading-normal"
                  >
                    창의실 (Room)
                  </legend>
                  <div
                    class="flex gap-4 rounded-DEFAULT bg-gray-50 px-3 py-3 dark:bg-slate-900"
                  >
                    <label class="flex items-center gap-2 text-sm">
                      <input
                        type="radio"
                        name="creative-room"
                        value="1실"
                        class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                        checked
                      />
                      <span>1실</span>
                    </label>
                    <label class="flex items-center gap-2 text-sm">
                      <input
                        type="radio"
                        name="creative-room"
                        value="2실"
                        class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                      />
                      <span>2실</span>
                    </label>
                  </div>
                </fieldset>

                <!-- 시간 -->
                <div class="flex flex-col">
                  <label
                    for="time"
                    class="pb-2 text-sm font-medium leading-normal"
                    >시간 (Time)</label
                  >
                  <select
                    id="time"
                    name="time"
                    required
                    class="form-select rounded-DEFAULT border-border-light bg-white text-sm shadow-sm focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                  >
                    <option value="">시간을 선택하세요</option>
                    <option value="자습1교시">자습 1교시</option>
                    <option value="자습2교시">자습 2교시</option>
                    <option value="야자1교시">야자 1교시</option>
                    <option value="야자2교시">야자 2교시</option>
                  </select>
                </div>
              </div>

              <div
                class="rounded-DEFAULT border border-dashed border-border-light bg-gray-50 px-3.5 py-3 text-xs text-gray-600 dark:border-border-dark dark:bg-slate-900 dark:text-gray-300"
              >
                제출 시 n8n 워크플로우로 전송되며, 중복 여부 확인 후 이메일과 아래
                “예약 결과” 영역에서 결과를 확인할 수 있습니다.
              </div>

              <button
                type="submit"
                id="reserve-submit"
                class="flex w-full items-center justify-center rounded-DEFAULT bg-primary px-4 py-2.5 text-sm font-semibold text-white shadow-md shadow-primary/30 transition hover:bg-blue-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2"
              >
                <span class="material-symbols-outlined mr-1.5 text-[18px]">
                  send
                </span>
                예약 신청 (Submit)
              </button>
            </form>
          </section>

          <!-- 3. 예약 결과 (예약/취소 후에만 보여줌) -->
          <section id="section-result" class="mt-8 hidden space-y-4">
            <h2 class="text-base font-semibold">예약 결과</h2>

            <div
              id="result-empty"
              class="flex flex-col items-center justify-center rounded-2xl border border-dashed border-border-light bg-gray-50 px-6 py-8 text-center text-sm text-gray-500 dark:border-border-dark dark:bg-slate-900 dark:text-gray-300"
            >
              <span class="material-symbols-outlined mb-2 text-3xl">
                info
              </span>
              아직 이 페이지에서 보낸 요청이 없습니다. 먼저 위에서 예약 또는
              아래에서 취소를 시도해 주세요.
            </div>

            <div
              id="result-card"
              class="hidden flex flex-col items-center gap-5 rounded-2xl border px-6 py-8 text-center shadow-md"
            >
              <div
                id="result-icon"
                class="flex h-16 w-16 items-center justify-center rounded-full"
              >
                <span class="material-symbols-outlined text-3xl">info</span>
              </div>
              <div>
                <h3
                  id="result-title"
                  class="text-xl font-bold tracking-tight"
                ></h3>
                <p
                  id="result-message"
                  class="mt-1 text-sm text-gray-600 dark:text-gray-300"
                ></p>
              </div>
              <div class="w-full max-w-md text-left text-xs text-gray-500">
                <p class="mb-1 font-semibold">요청 정보</p>
                <pre
                  id="result-payload"
                  class="whitespace-pre-wrap rounded-xl bg-gray-50 p-3 text-[11px] dark:bg-slate-900"
                ></pre>
              </div>
            </div>
          </section>

          <!-- 4. 예약 취소 (예약 성공했을 때 주로 사용) -->
          <section id="section-cancel" class="mt-8 hidden space-y-6">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-semibold">예약 취소</h2>
              <p class="text-[11px] text-gray-500">
                본인이 신청한 예약만 취소 가능합니다.
              </p>
            </div>

            <p id="cancel-status" class="hidden text-sm"></p>

            <form id="cancel-form" class="space-y-6">
              <p class="text-xs text-gray-600 dark:text-gray-400">
                취소할 예약 정보를 정확히 입력하면, n8n이 DataTable에서 일치하는
                예약을 찾아 삭제하고 결과를 이메일과 위 “예약 결과” 영역에
                알려줍니다.
              </p>

              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div class="flex flex-col">
                  <label
                    for="cancel-name"
                    class="pb-1.5 text-sm font-medium leading-normal"
                    >이름</label
                  >
                  <input
                    id="cancel-name"
                    name="name"
                    type="text"
                    required
                    class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                    placeholder="이름"
                  />
                </div>
                <div class="flex flex-col">
                  <label
                    for="cancel-student-id"
                    class="pb-1.5 text-sm font-medium leading-normal"
                    >학번</label
                  >
                  <input
                    id="cancel-student-id"
                    name="student-id"
                    type="text"
                    required
                    class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                    placeholder="예: 1416"
                  />
                </div>
              </div>

              <div class="flex flex-col">
                <label
                  for="cancel-email"
                  class="pb-1.5 text-sm font-medium leading-normal"
                  >이메일</label
                >
                <input
                  id="cancel-email"
                  name="email"
                  type="email"
                  required
                  class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                  placeholder="예약 시 사용한 이메일"
                />
              </div>

              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div class="flex flex-col">
                  <label
                    for="cancel-date"
                    class="pb-1.5 text-sm font-medium leading-normal"
                    >날짜</label
                  >
                  <input
                    id="cancel-date"
                    name="date"
                    type="date"
                    required
                    class="form-input rounded-DEFAULT border-border-light bg-white text-sm shadow-sm placeholder:text-gray-400 focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                  />
                </div>
                <div class="flex flex-col">
                  <label
                    for="cancel-time"
                    class="pb-1.5 text-sm font-medium leading-normal"
                    >시간</label
                  >
                  <select
                    id="cancel-time"
                    name="time"
                    required
                    class="form-select rounded-DEFAULT border-border-light bg-white text-sm shadow-sm focus:border-primary focus:ring-2 focus:ring-primary-soft dark:border-border-dark dark:bg-slate-900 dark:text-gray-100"
                  >
                    <option value="">선택</option>
                    <option value="자습1교시">자습 1교시</option>
                    <option value="자습2교시">자습 2교시</option>
                    <option value="야자1교시">야자 1교시</option>
                    <option value="야자2교시">야자 2교시</option>
                  </select>
                </div>
              </div>

              <fieldset>
                <legend
                  class="pb-1.5 text-sm font-medium leading-normal"
                >
                  창의실
                </legend>
                <div class="flex gap-4 pt-1">
                  <label class="flex items-center gap-2 text-sm">
                    <input
                      type="radio"
                      name="creative-room"
                      value="1실"
                      class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                      checked
                    />
                    <span>1실</span>
                  </label>
                  <label class="flex items-center gap-2 text-sm">
                    <input
                      type="radio"
                      name="creative-room"
                      value="2실"
                      class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                    />
                    <span>2실</span>
                  </label>
                </div>
              </fieldset>

              <div
                class="rounded-DEFAULT border border-dashed border-border-light bg-red-50/60 px-3.5 py-3 text-xs text-red-700 dark:border-border-dark dark:bg-red-900/20 dark:text-red-300"
              >
                예약 취소는 되돌릴 수 없습니다. 입력한 정보와 완전히 일치하는
                예약만 삭제됩니다.
              </div>

              <div class="flex justify-end">
                <button
                  type="submit"
                  id="cancel-submit"
                  class="flex items-center justify-center rounded-DEFAULT bg-error px-4 py-2 text-sm font-semibold text-white shadow-md hover:bg-red-700"
                >
                  예약 취소
                </button>
              </div>
            </form>
          </section>
        </main>
      </div>
    </div>

    <script>
      // === n8n Webhook URL 설정 ===
      // 예약: 이미 네가 만든 워크플로우 URL
      const N8N_RESERVE_URL =
        "https://n8n.taetae.dev/webhook/9eb4ab1b-25d4-445b-bdc1-ed7a9bf07d3a";

      // 현황 조회용 Webhook (Datatable 조회용 워크플로우를 따로 만들어야 함)
      const N8N_STATUS_URL =
        "https://n8n.taetae.dev/webhook/media-room-status";

      // 취소용 Webhook (Datatable 삭제용 워크플로우를 따로 만들어야 함)
      const N8N_CANCEL_URL =
        "https://n8n.taetae.dev/webhook/media-room-cancel";

      // === DOM 참조 ===
      const sectionReserve = document.getElementById("section-reserve");
      const sectionResult = document.getElementById("section-result");
      const sectionCancel = document.getElementById("section-cancel");

      const openReserveBtn = document.getElementById("open-reserve");
      const closeReserveBtn = document.getElementById("close-reserve");

      const statusStatus = document.getElementById("status-status");
      const statusBody = document.getElementById("status-body");
      const statusRefresh = document.getElementById("status-refresh");
      const roomFilterBtns = document.querySelectorAll(".room-filter-btn");

      const reserveForm = document.getElementById("reserve-form");
      const reserveStatus = document.getElementById("reserve-status");
      const reserveSubmit = document.getElementById("reserve-submit");

      const cancelForm = document.getElementById("cancel-form");
      const cancelStatus = document.getElementById("cancel-status");
      const cancelSubmit = document.getElementById("cancel-submit");

      const resultEmpty = document.getElementById("result-empty");
      const resultCard = document.getElementById("result-card");
      const resultIcon = document.getElementById("result-icon");
      const resultTitle = document.getElementById("result-title");
      const resultMessage = document.getElementById("result-message");
      const resultPayload = document.getElementById("result-payload");

      let allReservations = [];
      let currentRoomFilter = "all";

      let lastResult = null; // { type: 'reserve'|'cancel', success: bool, message, payload }

      // === 유틸 ===
      function setTextStatus(el, type, message) {
        el.classList.remove("hidden", "text-red-600", "text-green-600");
        if (type === "error") el.classList.add("text-red-600");
        if (type === "success") el.classList.add("text-green-600");
        el.textContent = message;
      }

      function renderResult() {
        sectionResult.classList.remove("hidden");
        if (!lastResult) {
          resultEmpty.classList.remove("hidden");
          resultCard.classList.add("hidden");
          return;
        }
        resultEmpty.classList.add("hidden");
        resultCard.classList.remove("hidden");

        // 아이콘 색/스타일
        resultIcon.className =
          "flex h-16 w-16 items-center justify-center rounded-full";
        resultIcon.classList.add(
          lastResult.success ? "bg-success/10 text-success" : "bg-error/10 text-error"
        );

        resultTitle.textContent = lastResult.success
          ? lastResult.type === "reserve"
            ? "예약이 완료되었습니다"
            : "예약 취소가 완료되었습니다"
          : lastResult.type === "reserve"
          ? "예약에 실패했습니다"
          : "예약 취소에 실패했습니다";

        resultMessage.textContent =
          lastResult.message ||
          (lastResult.success
            ? "요청이 정상 처리되었습니다."
            : "요청 처리 중 오류가 발생했습니다.");

        resultPayload.textContent = JSON.stringify(lastResult.payload, null, 2);
      }

      function renderReservations() {
        statusBody.innerHTML = "";

        const rows = allReservations.filter((r) => {
          if (currentRoomFilter === "all") return true;
          return r.roomnum === currentRoomFilter;
        });

        if (rows.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td colspan="7" class="px-4 py-4 text-center text-sm text-gray-500">표시할 예약이 없습니다.</td>';
          statusBody.appendChild(tr);
          return;
        }

        rows.forEach((r) => {
          const tr = document.createElement("tr");
          tr.className =
            "hover:bg-background-light dark:hover:bg-background-dark transition-colors";
          tr.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap">${r.roomnum ?? ""}</td>
            <td class="px-4 py-3 whitespace-nowrap">${r.date ?? ""}</td>
            <td class="px-4 py-3 whitespace-nowrap">${r.time ?? ""}</td>
            <td class="px-4 py-3 font-medium">${r.name ?? ""}</td>
            <td class="hidden px-4 py-3 md:table-cell">${r.User ?? ""}</td>
            <td class="hidden px-4 py-3 lg:table-cell">${r.purpose ?? ""}</td>
            <td class="px-4 py-3 text-center">
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold
                ${
                  (r.status ?? "") === "예약 완료"
                    ? "bg-emerald-100 text-emerald-800"
                    : "bg-blue-100 text-blue-800"
                }">
                ${r.status ?? "예약"}
              </span>
            </td>
          `;
          statusBody.appendChild(tr);
        });
      }

      async function fetchReservations() {
        statusStatus.textContent = "예약 목록을 불러오는 중입니다...";
        try {
          const res = await fetch(N8N_STATUS_URL);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          allReservations = Array.isArray(data) ? data : [];
          statusStatus.textContent = `총 ${allReservations.length}건의 예약을 불러왔습니다.`;
          renderReservations();
        } catch (err) {
          console.error(err);
          statusStatus.textContent =
            "예약 목록을 불러오는 데 실패했습니다. n8n 현황 Webhook URL을 확인하세요.";
        }
      }

      // === 이벤트: 현황 필터 / 새로고침 ===
      roomFilterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          roomFilterBtns.forEach((b) =>
            b.classList.remove("bg-primary", "text-white")
          );
          btn.classList.add("bg-primary", "text-white");
          currentRoomFilter = btn.getAttribute("data-room-filter");
          renderReservations();
        });
      });

      statusRefresh.addEventListener("click", () => {
        fetchReservations();
      });

      // === 이벤트: 예약하기 열기/접기 ===
      openReserveBtn.addEventListener("click", () => {
        sectionReserve.classList.remove("hidden");
        // 예약 섹션으로 스크롤
        sectionReserve.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      closeReserveBtn.addEventListener("click", () => {
        sectionReserve.classList.add("hidden");
      });

      // === 이벤트: 예약 제출 ===
      reserveForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fd = new FormData(reserveForm);
        const payload = {
          name: fd.get("name")?.trim(),
          "student-id": fd.get("student-id")?.trim(),
          email: fd.get("email")?.trim(),
          date: fd.get("date"),
          "creative-room": fd.get("creative-room"),
          time: fd.get("time"),
        };

        if (
          !payload.name ||
          !payload["student-id"] ||
          !payload.email ||
          !payload.date ||
          !payload["creative-room"] ||
          !payload.time
        ) {
          setTextStatus(
            reserveStatus,
            "error",
            "모든 필드(이름, 학번, 이메일, 날짜, 창의실, 시간)를 입력하세요."
          );
          return;
        }

        reserveSubmit.disabled = true;
        reserveSubmit.textContent = "전송 중...";

        try {
          const res = await fetch(N8N_RESERVE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }

          // n8n에서 {success: true/false, message: "..."} 형식으로 돌려준다고 가정
          const data = await res.json().catch(() => ({}));
          const success = data.success !== false;
          const message =
            data.message ||
            (success
              ? "예약 요청이 전송되었습니다. 이메일을 확인해주세요."
              : "예약에 실패했습니다.");

          setTextStatus(
            reserveStatus,
            success ? "success" : "error",
            message
          );

          // 마지막 결과 저장 + 결과 섹션 표시
          lastResult = {
            type: "reserve",
            success,
            message,
            payload,
          };
          renderResult();

          if (success) {
            reserveForm.reset();
            // 성공했으면 취소 섹션도 노출 (사용자가 바로 취소할 수 있도록)
            sectionCancel.classList.remove("hidden");

            // 현황 자동 새로고침
            fetchReservations();

            // 취소 폼에 일부 정보를 자동 채워줘도 편함
            document.getElementById("cancel-name").value = payload.name;
            document.getElementById("cancel-student-id").value =
              payload["student-id"];
            document.getElementById("cancel-email").value = payload.email;
            document.getElementById("cancel-date").value = payload.date;
            document.getElementById("cancel-time").value = payload.time;
            const roomInputs = document.querySelectorAll(
              'input[name="creative-room"]'
            );
            roomInputs.forEach((r) => {
              r.checked = r.value === payload["creative-room"];
            });
          }
        } catch (err) {
          console.error(err);
          const msg =
            "예약 요청 중 오류가 발생했습니다. CORS 또는 n8n 설정을 확인하세요.";
          setTextStatus(reserveStatus, "error", msg);
          lastResult = {
            type: "reserve",
            success: false,
            message: msg,
            payload,
          };
          renderResult();
        } finally {
          reserveSubmit.disabled = false;
          reserveSubmit.textContent = "예약 신청 (Submit)";
        }
      });

      // === 이벤트: 예약 취소 ===
      cancelForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fd = new FormData(cancelForm);
        const payload = {
          name: fd.get("name")?.trim(),
          "student-id": fd.get("student-id")?.trim(),
          email: fd.get("email")?.trim(),
          date: fd.get("date"),
          time: fd.get("time"),
          "creative-room": fd.get("creative-room"),
        };

        if (
          !payload.name ||
          !payload["student-id"] ||
          !payload.email ||
          !payload.date ||
          !payload.time ||
          !payload["creative-room"]
        ) {
          setTextStatus(cancelStatus, "error", "모든 필드를 정확히 입력해주세요.");
          return;
        }

        if (
          !confirm(
            "정말 이 예약을 취소하시겠습니까? 이 작업은 되돌릴 수 없습니다."
          )
        ) {
          return;
        }

        cancelSubmit.disabled = true;
        cancelSubmit.textContent = "취소 요청 중...";

        try {
          const res = await fetch(N8N_CANCEL_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }

          const data = await res.json().catch(() => ({}));
          const success = data.success !== false;
          const message =
            data.message ||
            (success
              ? "예약이 정상적으로 취소되었습니다."
              : "예약을 찾지 못했거나 취소에 실패했습니다.");

          setTextStatus(
            cancelStatus,
            success ? "success" : "error",
            message
          );

          lastResult = {
            type: "cancel",
            success,
            message,
            payload,
          };
          renderResult();

          if (success) {
            // 현황 갱신
            fetchReservations();
          }
        } catch (err) {
          console.error(err);
          const msg =
            "취소 요청 중 오류가 발생했습니다. n8n 취소 Webhook URL을 확인하세요.";
          setTextStatus(cancelStatus, "error", msg);
          lastResult = {
            type: "cancel",
            success: false,
            message: msg,
            payload,
          };
          renderResult();
        } finally {
          cancelSubmit.disabled = false;
          cancelSubmit.textContent = "예약 취소";
        }
      });

      // 페이지 로드 시 현황 한 번 불러오기
      fetchReservations();
    </script>
  </body>
</html>
